/**
 * Class responsible for filtering photos into NDVI readable images
 */

var Caman = require('caman').Caman;
var gm = require('gm').subClass({ imageMagick: true });

Caman.Filter.register("ndvi", function (adjust) {

    this.process("ndvi", function(rgba) {
        // Calculate the ndvi val for this pixel
        ndvi = (rgba.b - rgba.r) / (rgba.b + rgba.r);

        ndvi *= 1.5;

        // set the green value
        rgba.g = (1 - Math.abs(ndvi)) * 255;

        // adjust the ndvi value
        ndvi = (ndvi + 1) / 2;

        // set the red and blue values
        rgba.r = 255 * ndvi;

        rgba.b = 255 * (1 - ndvi);

        // return the modified RGB value
        return rgba;
    });
});

exports.doNdvi = function(nirImg)
{
    Caman(nirImg, function() {
        this.ndvi();

        this.render(function() {
          console.log("saving");
          this.save("ndvi_" + nirImg);

          gm().append(nirImg)
              .append("ndvi_" + nirImg)
              .write(nirImg, function(err) {
                
              });
        });
    });
}
