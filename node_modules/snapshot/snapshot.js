var servo = require('servo-control/servo-control.js');
var shell = require('shelljs');
var fs = require('fs');
var gm = require('gm').subClass({ imageMagick: true });

var TIME_TO_MOVE = 5000;

var PHOTO_DIR = "/home/snapshot/public/images/plants/";

module.exports = {
  snapImage: function(dir, imgOut, callback)
  {
    console.log("snapping image");

    if (!fs.existsSync(dir))
    {
        fs.mkdirSync(dir);
    }

    // return both motors to the home position
    servo.returnHome(servo.motorHorizontal_, function() {

    });
    servo.returnHome(servo.motorVertical_, function() {

    });

    // assume both motors are in the home position
    var posHor = servo.motorVertical_.HOME;
    var posVer = servo.motorHorizontal_.HOME;
    // schedule all of the movement
    var photoNum = 0;
    var degree = 0.04;

    setTimeout(servo.moveMotor, 0 * TIME_TO_MOVE, servo.motorHorizontal_,
          0.04,
          function() {
            capture(dir + "0.jpeg");
    });

    setTimeout(servo.moveMotor, 1 * TIME_TO_MOVE, servo.motorHorizontal_,
          0.09,
          function() {
            capture(dir + "1.jpeg");
    });

    setTimeout(servo.moveMotor, 2 * TIME_TO_MOVE, servo.motorHorizontal_,
          0.15,
          function() {
            capture(dir + "2.jpeg");
    });

    setTimeout(servo.moveMotor, 3 * TIME_TO_MOVE, servo.motorHorizontal_,
          0.213,
          function() {
            capture(dir + "3.jpeg");
    });

   // setTimeout(servo.moveMotor, 4 * TIME_TO_MOVE, servo.motorHorizontal_,
   //       0.24,
   //       function() {
   //         capture(dir + "4.jpeg");
   // });

    setTimeout(function()
    {
       stitchPhotos(dir, imgOut);
       shell.exec("rm -r " + dir);
       callback();
    }, 5 * TIME_TO_MOVE );
  }
}

function stitchPhotos(dir, imgOut)
{
  console.log("stitching");
  // create a graphics magick object
  var gmm = gm();
  // append each of the images
  console.log("attempting to stitch");
  if (fs.existsSync(dir))
  {
      var files = fs.readdirSync(dir);
      for (i = 0; i < files.length; ++i)
      {
        console.log("appending " + dir + files[i]);
        gmm.append(dir + files[i]);
      }
  }

  gmm.append(true); // append horizontally
  gmm.write(imgOut, function (err) {
      if (err) console.log(err);
  });
}

function capture(path)
{
  console.log("taking snapshot!");
  shell.exec("fswebcam -r 1280x720 --jpeg 100 --rotate 270 -D 1 " + path)
}
